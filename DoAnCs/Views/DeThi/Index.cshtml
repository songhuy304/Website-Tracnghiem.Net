@model PagedList.PagedList<DoAnCs.Models.Exam>
<link href="~/Content/PagedList.css" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" href="styles/categories_styles.css">
<link rel="stylesheet" type="text/css" href="~/Content/asset/styles/single_styles.css">
<link rel="stylesheet" type="text/css" href="~/Content/asset/styles/contact_responsive.css">

@using PagedList.Mvc;
@using System.Text.RegularExpressions;

@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div style="margin-top:130px;" class="container">
    <div id="carouselExampleControls" class="carousel slide" style="margin:80px; " data-ride="carousel">
        <div class="carousel-inner shadow-lg" style="height:200px;">
            <div class="carousel-item active shadow-lg">
                <img class="d-block w-100 shadow-lg" style="border-radius:16px" src="~/Content/Images/1sli.png" alt="First slide">
            </div>
            <div class="carousel-item shadow-lg">
                <img class="d-block w-100 shadow-lg" style="border-radius:16px" src="~/Content/Images/2sli.png" alt="Second slide">
            </div>
            <div class="carousel-item shadow-lg">
                <img class="d-block w-100 shadow-lg" style="border-radius:16px" src="~/Content/Images/3sli.png" alt="Third slide">
            </div>
        </div>
        <a class="carousel-control-prev" href="#carouselExampleControls" role="button" data-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="sr-only">Previous</span>
        </a>
        <a class="carousel-control-next" href="#carouselExampleControls" role="button" data-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="sr-only">Next</span>
        </a>
    </div>
</div>


@*<section class="dethii">
        <div class="container" style="display: flex; justify-content: end;">
            @using (Html.BeginForm("Index", "DeThi", FormMethod.Get))
            {

                @Html.TextBox("searchString", ViewBag.CurrentFilter as string)
                <input type="submit" value="Search" class="btn btn-success" />
            }
        </div>
    </section>*@

<section class="dethii">
    <div class="row">
        <div style="border-radius: 16px; margin-left:95px" class="col-md-2  shadow-lg">

            @Html.Action("PartialView_sidebar", "Dethi")
        </div>
        <div class="col-md-9">
            @if (Model != null && Model.Any())
            {

                <div class="container">
                    <h3>Đề Thi Mới Nhất</h3>
                    <div class="row">
                        @foreach (var item in Model)
                        {

                            <div class="card shadow-lg" id="cardvaothi" style="width: 18rem; border-radius:16px;">
                                @Html.Raw(item.image)
                                <div class="card-body">
                                    <strong>@item.NameExam</strong>
                                    <p style="color:red;" data-id="@item.Time" class="card-text">Số Lượng Câu Hỏi:@item.NumberQ - Số Phút: @item.Time </p>
                                    <p class="card-text">Lượt Thi: @item.Viewcount </p>
                                    <button style="width:100%" class="btn btn-primary chitiet" data-subject-id="@item.IdExam" data-name="@item.NameExam">Vào Thi</button>
                                </div>


                            </div>


                        }
                    </div>
                    @Html.PagedListPager(Model, page => Url.Action("Index",
                       new { page, currentFilter = ViewBag.CurrentFilter }))
                </div>
            }
        </div>
    </div>





    @Html.Action("partialModalReview", "Home")

</section>





@section scripts{
    <script src="~/Scripts/Dethi.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <script>




        $(document).ready(function () {
            var idToRedirect = null;
           
            //$('.chitiet').on('click', function () {
            //    idToRedirect = $(this).data('subject-id');
            //    var examId = $(this).data('subject-id');
            //    $.ajax({
            //        url: "/Home/detail/" + examId, // Replace ControllerName with your actual controller name
            //        type: 'GET',
            //        success: function (data) {
            //            if (data.error) {
            //                alert(data.error);
            //            } else {
            //                $('#examId').text(data.exam.IdExam);
            //                $('#examName123').text(data.exam.NameExam);
            //                if (data.exam.image) {
            //                    $('#examImage123').removeAttr('src'); // Xóa thuộc tính src nếu không có hình ảnh
            //                    var htmlString = data.exam.image;
            //                    var srcRegex = /src="([^"]*)"/;
            //                    var match = htmlString.match(srcRegex);
            //                    if (match && match.length > 1) {
            //                        var srcValue = match[1];
            //                        $('#examImage123').attr('src', srcValue);// Sử dụng URL hình ảnh từ dữ liệu nhận được
            //                    }
            //                } else {
            //                    $('#examImage123').attr('src', ''); // Thiết lập thuộc tính src thành chuỗi rỗng để hiển thị hình ảnh là null
            //                }
            //                $('#chitietModal').modal('show');
            //            }
            //        },
            //        error: function () {
            //            alert('Error retrieving exam details.');
            //        }
            //    });
            //    // Phần Review Exam
            //    $.ajax({
            //        url: "/Home/ReviewExam/" + examId, // Replace ControllerName with your actual controller name
            //        type: 'GET',
            //        success: function (data) {
            //            if (data.error) {
            //                alert(data.error);
            //            } else {
            //                var examReviews = data.examReview;
            //                console.log(data);
            //                var reviewContainer = $('.reviews_col'); // Thay thế bằng lớp hoặc id của phần tử chứa đánh giá
            //                reviewContainer.empty();
            //                examReviews.forEach(function (review) {


            //                    var userReview = `
            //        <div class="user_review_container d-flex flex-column flex-sm-row">
            //            <div class="user">
            //                <div class="user_pic"></div>
            //                <div class="user_rating">
            //                    <ul class="star_rating">
            //                        ${generateStarRating(review.Rate)}
            //                    </ul>
            //                </div>
            //            </div>
            //            <div class="review">
            //                <div class="review_date">${review.CreateDate}</div>
            //                <div class="user_name">${review.userName}</div>
            //                <p>${review.Description}</p>
            //            </div>
            //        </div>
            //    `;

            //                    // Thêm đánh giá vào phần tử chứa đánh giá
            //                    reviewContainer.append(userReview);
            //                });
            //            }
            //        },
            //        error: function () {
            //            alert('Error retrieving exam details.');
            //        }
            //    });


            //});
            $('.chitiet').on('click', function () {
                const examId = $(this).data('subject-id');
                idToRedirect = $(this).data('subject-id');

                const examDetailUrl = `/Home/detail/${examId}`;
                const reviewExamUrl = `/Home/ReviewExam/${examId}`;

                const $examId = $('#examId');
                const $examName = $('#examName123');
                const $examImage = $('#examImage123');
                const $chitietModal = $('#chitietModal');
                const $reviewContainer = $('.reviews_col');

                // Function to generate star rating HTML
                const generateStarRating = (rate) => {
                    let starsHTML = '';
                    for (let i = 1; i <= 5; i++) {
                        if (i <= rate) {
                            starsHTML += `<li><i class="fa fa-star" aria-hidden="true"></i></li>`;
                        } else {
                            starsHTML += `<li><i class="fa fa-star-o" aria-hidden="true"></i></li>`;
                        }
                    }
                    return starsHTML;
                };

                const renderExamDetails = (data) => {
                    if (data.error) {
                        alert(data.error);
                        return;
                    }

                    const { exam } = data;
                    $examId.text(exam.IdExam);
                    $examName.text(exam.NameExam);

                    if (exam.image) {
                        const htmlString = exam.image;
                        const srcRegex = /src="([^"]*)"/;
                        const match = htmlString.match(srcRegex);
                        const srcValue = match && match.length > 1 ? match[1] : '';
                        $examImage.attr('src', srcValue);
                    } else {
                        $examImage.attr('src', '');
                    }

                    $chitietModal.modal('show');
                };

                const renderExamReviews = (data) => {
                    if (data.error) {
                        alert(data.error);
                        return;
                    }

                    const examReviews = data.examReview || [];
                    $reviewContainer.empty();

                    examReviews.forEach((review) => {
                        const userReview = `
                <div class="user_review_container d-flex flex-column flex-sm-row">
                    <div class="user">
                      <img src="https://mdbcdn.b-cdn.net/img/new/avatars/2.webp" class="rounded-circle" style="width: 70px;"
  alt="Avatar" />
                        <div class="user_rating">
                            <ul class="star_rating">
                                ${generateStarRating(review.Rate)}
                            </ul>
                        </div>
                    </div>
                    <div class="review">
                        <div class="review_date">${review.CreateDate}</div>
                        <div class="user_name">${review.userName}</div>
                        <p>${review.Description}</p>
                    </div>
                </div>
            `;

                        $reviewContainer.append(userReview);
                    });
                };

                $.ajax({
                    url: examDetailUrl,
                    type: 'GET',
                    success: renderExamDetails,
                    error: function () {
                        alert('Error retrieving exam details.');
                    }
                });

                $.ajax({
                    url: reviewExamUrl,
                    type: 'GET',
                    success: renderExamReviews,
                    error: function () {
                        alert('Error retrieving exam reviews.');
                    }
                });
            });
          
            // Xác nhận hành động khi nhấn nút "Xác nhận" trong modal
            $('#confirmAction').on('click', function () {
                if (idToRedirect) {
                    $('#confirmationModal').modal('hide');


                    setTimeout(function () {
                        localStorage.clear();
                        sessionStorage.clear();
                        window.location.href = '/Dethi/Dethi/' + idToRedirect; // Thay 'View2' bằng đường dẫn của view thứ 2
                    }, 2000);

                }
            });
            $('.close').on('click', function () {
                $('#confirmationModal').modal('hide');
            });
        });








    </script>
}
